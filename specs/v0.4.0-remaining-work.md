# Remote.py v0.4.0 Remaining Work

Work through the issues described in this document.
Once an issue has been resolved, run the tests, atomic commit and push to the branch.
Update this spec after each issue.
Continue until all the issues are resolved.
Once you've completed the issues here make a review of the repo for usability, security and code quality, and create new issues in the spec.

## Remaining Work for v0.4.0

### Critical Bugs

#### 1. Fix `read_config()` Parameter Bug
**GitHub Issue:** Part of #51
**File:** `remotepy/config.py`
**Status:** COMPLETED

**Problem:**
```python
def read_config(config_path):
    cfg = configparser.ConfigParser()
    cfg.read(CONFIG_PATH)  # BUG: Uses global CONFIG_PATH, ignores parameter
    return cfg
```

**Solution:** Change `CONFIG_PATH` to `config_path`.

**Acceptance Criteria:**
- [x] `read_config()` uses the provided parameter
- [x] Test added to verify custom config paths work

---

#### 2. Fix `create-snapshot` Input Validation (#15)
**GitHub Issue:** #15
**File:** `remotepy/snapshot.py`
**Status:** COMPLETED

**Problem:** `create-snapshot` crashes with ParamValidationError when called without required options.

**Solution:** Add input validation before calling AWS API:
```python
def create(
    volume_id: str = typer.Option(..., help="Volume ID"),  # Make required
    name: str = typer.Option(..., help="Snapshot name"),   # Make required
    description: str = typer.Option("", help="Description"),
):
```

Or validate and prompt for missing values.

**Acceptance Criteria:**
- [x] Command provides helpful error if required options missing
- [x] No unhandled exceptions from AWS SDK

---

### Security Improvements

#### 3. Fix SSH Host Key Verification (#54)
**GitHub Issue:** Part of #54
**File:** `remotepy/instance.py:279`
**Status:** COMPLETED

**Problem:**
```python
"StrictHostKeyChecking=no",  # Vulnerable to MITM attacks
```

**Solution:** Change to `StrictHostKeyChecking=accept-new`:
- Accepts new host keys automatically (convenience)
- Rejects changed keys (security against MITM)

**Acceptance Criteria:**
- [x] Default uses `accept-new`
- [x] Optional `--no-strict-host-key` flag for legacy behavior

---

### Code Quality

#### 4. Add Comprehensive Type Hints (#52)
**GitHub Issue:** #52
**Status:** COMPLETED

**Completed work:**
- [x] Add mypy configuration to pyproject.toml
- [x] Run `mypy --strict` and fix issues
- [x] Add mypy to CI pipeline
- [x] Added boto3-stubs for AWS client type annotations

---

#### 5. Implement AWS API Pagination
**Status:** COMPLETED

**Problem:** List operations don't handle >100 items.

**Solution:** Used boto3 paginators for:
- [x] `get_instances()` in utils.py
- [x] `get_all_clusters()` in ecs.py
- [x] `get_all_services()` in ecs.py

---

### Architecture

#### 6. Dependency Injection for AWS Clients (#53)
**GitHub Issue:** #53
**Status:** COMPLETED

**Problem:** Module-level boto3 clients make testing harder and prevent lazy initialization.

**Solution implemented:**
```python
from functools import lru_cache

@lru_cache
def get_ec2_client():
    return boto3.client("ec2")

# Backwards compatibility alias
ec2_client = get_ec2_client()
```

---

#### 7. Configuration Management (#51)
**GitHub Issue:** #51
**Status:** Partially done (read_config bug FIXED)

Additional work:
- [x] Fix read_config parameter bug
- [ ] Consider using pydantic for config validation
- [ ] Support environment variable overrides

---

#### 9. Document pipx Installation (#31)
**GitHub Issue:** #31
**Status:** Documentation exists

**Remaining work:**
- [ ] Verify pipx install works after PyPI upload
- [ ] Add pipx to README as primary method

---

### Enhancements

#### 10. Add Instance Pricing (#32)
**GitHub Issue:** #32
**Status:** Not started

**Description:** Show instance pricing in `remote list` output.

**Complexity:** Medium - requires AWS Pricing API integration.

---

#### 11. Rename Package to `remote` (#26)
**GitHub Issue:** #26
**Status:** Not started

**Current:** Package folder is `remotepy`
**Target:** Rename to `remote`

**Considerations:**
- Breaking change for existing users
- May conflict with other packages
- Requires updating all imports

**Decision:** Defer to v1.0.0 or leave as-is.

---

### Documentation

#### 12. Development Instructions (#25)
**GitHub Issue:** #25
**Status:** Mostly done

**Remaining:**
- [ ] Verify editable install instructions work with uv
- [ ] Add contributing guide

---

## Issues Found During Code Review

The following issues were discovered during a comprehensive code review:

### High Priority

#### 13. Logic Bug in `get_instance_by_name()` Loop
**File:** `remotepy/utils.py:333`
**Status:** Not started

**Problem:** When iterating through reservations to find an instance by name, if the first instance is terminated, the loop breaks entirely instead of continuing to check other instances.

```python
if instance_state == "terminated":
    break  # BUG: Should be 'continue' to check other instances
```

**Solution:** Change `break` to `continue`.

**Acceptance Criteria:**
- [ ] Change break to continue on line 333
- [ ] Add test case for terminated instances in reservations

---

#### 14. SSH Subprocess No Error Handling
**File:** `remotepy/instance.py:309`
**Status:** Not started

**Problem:** The `subprocess.run()` call for SSH has no error handling. If SSH fails (e.g., connection refused, host unreachable), the error is not caught or reported properly.

```python
subprocess.run(ssh_command)  # No error handling
```

**Solution:** Add try/except or check return code and provide user-friendly error message.

**Acceptance Criteria:**
- [ ] Catch subprocess errors and provide helpful message
- [ ] Exit with appropriate code on SSH failure

---

#### 15. Unvalidated Array Index in AMI Launch
**File:** `remotepy/ami.py:186`
**Status:** Not started

**Problem:** Direct array indexing without bounds checking could cause IndexError if the list is empty.

```python
instance_ids[0]  # Potential IndexError
```

**Solution:** Use `safe_get_array_item()` from validation module or check list length first.

**Acceptance Criteria:**
- [ ] Add bounds checking before array access
- [ ] Provide helpful error if no instances returned

---

### Medium Priority

#### 16. Deprecated `datetime.utcfromtimestamp()` Usage
**File:** `remotepy/utils.py:353`
**Status:** Not started

**Problem:** `datetime.utcfromtimestamp()` is deprecated in Python 3.12+.

**Solution:** Replace with:
```python
from datetime import datetime, timezone
datetime.fromtimestamp(timestamp, tz=timezone.utc)
```

**Acceptance Criteria:**
- [ ] Replace deprecated datetime call
- [ ] Ensure tests pass with Python 3.12+

---

#### 17. Inconsistent Output Patterns in config.py
**File:** `remotepy/config.py`
**Status:** Not started

**Problem:** Uses `print()` statements while rest of codebase uses `typer.secho()` for consistent colored output.

**Solution:** Replace `print()` calls with `typer.secho()` using appropriate colors.

**Acceptance Criteria:**
- [ ] Replace print() with typer.secho()
- [ ] Use consistent color scheme (GREEN for success, RED for errors)

---

#### 18. Standardize Exit Patterns
**Files:** Multiple files
**Status:** Not started

**Problem:** Inconsistent exit handling - some places use `typer.Exit()`, others use `sys.exit()`, and some return early.

**Solution:** Use `raise typer.Exit(code)` consistently throughout all command handlers.

**Acceptance Criteria:**
- [ ] Audit all exit points
- [ ] Standardize on typer.Exit pattern

---

### Low Priority

#### 19. Function Name Shadows Builtin
**File:** `remotepy/instance.py`
**Status:** Not started

**Problem:** Function named `list` shadows Python builtin. While it works due to Typer's command registration, it's a code smell and can cause issues with type hints.

**Solution:** Rename function to `list_instances` and use `@app.command(name="list")` for CLI.

**Acceptance Criteria:**
- [ ] Rename function internally
- [ ] Keep CLI command name as "list"

---

#### 20. Improve Test Coverage for Edge Cases
**Files:** Test files
**Status:** Not started

**Problem:** Some edge cases not covered:
- Empty pagination responses
- Multiple pages of results
- Concurrent access to cached clients

**Solution:** Add additional test cases.

**Acceptance Criteria:**
- [ ] Add tests for empty pagination
- [ ] Add tests for multi-page results
- [ ] Maintain 100% test coverage

---

## Implementation Priority

### High Priority (v0.4.0) - COMPLETED
1. ~~Fix `read_config()` parameter bug (#51)~~ DONE
2. ~~Fix `create-snapshot` input validation (#15)~~ DONE
3. ~~Fix SSH StrictHostKeyChecking (#54)~~ DONE
4. ~~Add comprehensive type hints + mypy (#52)~~ DONE
5. ~~Implement AWS API pagination~~ DONE
6. ~~Dependency injection for clients (#53)~~ DONE

### High Priority (v0.4.x) - From Code Review
13. Fix logic bug in `get_instance_by_name()` (break â†’ continue)
14. Add SSH subprocess error handling
15. Fix unvalidated array index in AMI launch

### Medium Priority (v0.4.x) - From Code Review
16. Replace deprecated datetime.utcfromtimestamp()
17. Standardize output patterns in config.py
18. Standardize exit patterns across codebase

### Low Priority (v0.5.0+)
8. Add instance pricing (#32)
9. Rename package to `remote` (#26)
19. Rename `list` function to avoid shadowing builtin
20. Improve test coverage for edge cases

---

## GitHub Issue Summary

| Issue | Title | Status | Target |
|-------|-------|--------|--------|
| #54 | Security practices | **COMPLETED** (SSH fixed) | v0.4.0 |
| #53 | Dependency injection | **COMPLETED** | v0.4.0 |
| #52 | Type hints | **COMPLETED** | v0.4.0 |
| #51 | Configuration management | **Partial** (read_config fixed) | v0.4.0 |
| #32 | Add price | Open | v0.5.0 |
| #31 | Install with pipx | Open | v0.4.0 |
| #26 | Rename source folder | Open | v1.0.0 |
| #25 | Development instructions | Open | v0.4.0 |
| #15 | create-snapshot errors | **CLOSED** | v0.4.0 |
| #49 | Duplicate functions | **Close** | - |
| #50 | Error handling | **Close** | - |
| #24 | GitHub action tests | **Close** | - |
| #6 | Error if no credentials | **Close** | - |
| #1 | Initial functionality | **Close** | - |

### New Issues from Code Review (not yet filed on GitHub)

| ID | Title | Priority | Target |
|----|-------|----------|--------|
| 13 | Logic bug in get_instance_by_name() | High | v0.4.x |
| 14 | SSH subprocess error handling | High | v0.4.x |
| 15 | Unvalidated array index in AMI launch | High | v0.4.x |
| 16 | Deprecated datetime.utcfromtimestamp() | Medium | v0.4.x |
| 17 | Inconsistent output patterns in config.py | Medium | v0.4.x |
| 18 | Standardize exit patterns | Medium | v0.4.x |
| 19 | Function name shadows builtin | Low | v0.5.0 |
| 20 | Improve test coverage for edge cases | Low | v0.5.0 |
